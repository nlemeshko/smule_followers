import asyncio
import aiohttp
import json
import os
import ssl
import certifi
from telegram import Bot
from telegram.error import TelegramError
import logging
from datetime import datetime
from dotenv import load_dotenv

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# env + –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
load_dotenv()
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)


class SmuleFollowersBot:
    def __init__(self, telegram_token: str, chat_id: str, account_ids):
        """
        Args:
            telegram_token: —Ç–æ–∫–µ–Ω Telegram-–±–æ—Ç–∞
            chat_id: —á–∞—Ç –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            account_ids: list[str] –∞–∫–∫–∞—É–Ω—Ç–æ–≤ Smule
        """
        self.bot = Bot(token=telegram_token)
        self.chat_id = chat_id
        self.account_ids = account_ids if isinstance(account_ids, list) else [account_ids]

        # –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∫ Smule API
        self.headers = {
            "User-Agent": ("Mozilla/5.0 (Windows NT 10.0; Win64; x64) "
                           "AppleWebKit/537.36 (KHTML, like Gecko) "
                           "Chrome/123.0.0.0 Safari/537.36"),
            "Accept": "application/json, text/plain, */*",
            "Accept-Language": "en-US,en;q=0.9",
            "Cache-Control": "no-cache",
            "Pragma": "no-cache",
            "Connection": "keep-alive",
        }

        # –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ –∏ –∫—ç—à –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
        self.known_followers: dict[str, set[str]] = {}
        self.followers_meta: dict[str, dict[str, dict]] = {}  # {account_id: {follower_id: info}}

        for account_id in self.account_ids:
            self.known_followers[account_id] = self._load_followers_set(account_id)
            self.followers_meta[account_id] = self._load_followers_meta(account_id)

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏ (—Å–ª–µ–ø–æ–∫ id –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ)
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    def _followers_file(self, account_id: str) -> str:
        return f"followers_{account_id}.json"

    def _followers_meta_file(self, account_id: str) -> str:
        return f"followers_meta_{account_id}.json"

    def _load_followers_set(self, account_id: str) -> set:
        fp = self._followers_file(account_id)
        try:
            if os.path.exists(fp):
                with open(fp, "r", encoding="utf-8") as f:
                    data = json.load(f)
                    return set(data) if isinstance(data, list) else set()
            return set()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ ({account_id}): {e}")
            return set()

    def _save_followers_set(self, account_id: str) -> None:
        fp = self._followers_file(account_id)
        try:
            with open(fp, "w", encoding="utf-8") as f:
                json.dump(sorted(self.known_followers[account_id]), f, ensure_ascii=False, indent=2)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ ({account_id}): {e}")

    def _load_followers_meta(self, account_id: str) -> dict:
        fp = self._followers_meta_file(account_id)
        try:
            if os.path.exists(fp):
                with open(fp, "r", encoding="utf-8") as f:
                    data = json.load(f)
                    return data if isinstance(data, dict) else {}
            return {}
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ ({account_id}): {e}")
            return {}

    def _save_followers_meta(self, account_id: str) -> None:
        fp = self._followers_meta_file(account_id)
        try:
            with open(fp, "w", encoding="utf-8") as f:
                json.dump(self.followers_meta[account_id], f, ensure_ascii=False, indent=2)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ ({account_id}): {e}")

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # HTTP-—Å–µ—Å—Å–∏—è —Å –≤–∞–ª–∏–¥–Ω—ã–º CA (certifi)
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    def _build_session(self) -> aiohttp.ClientSession:
        ssl_ctx = ssl.create_default_context(cafile=certifi.where())
        timeout = aiohttp.ClientTimeout(total=30, connect=15, sock_read=15)
        connector = aiohttp.TCPConnector(ssl=ssl_ctx, limit=10)
        return aiohttp.ClientSession(connector=connector, timeout=timeout)

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # Smule API + —Ä–µ—Ç—Ä–∞–∏
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async def _get_followers_page(self, session: aiohttp.ClientSession,
                                  account_id: str, offset: int = 0, limit: int = 20) -> dict | None:
        url = "https://www.smule.com/api/profile/followers"
        params = {"accountId": account_id, "offset": offset, "limit": limit}

        for attempt in range(1, 4):
            try:
                async with session.get(url, params=params, headers=self.headers) as resp:
                    if resp.status == 200:
                        return await resp.json()
                    text = await resp.text()
                    logger.error(f"HTTP {resp.status} {url} {params} ‚Üí {text[:300]}")
                    return None
            except aiohttp.ClientSSLError as e:
                logger.error(f"TLS –æ—à–∏–±–∫–∞ (Smule, {account_id}): {e}")
                return None
            except Exception as e:
                logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ {attempt}/3, –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ ({account_id}): {e}")
                await asyncio.sleep(1.5 * attempt)
        return None

    async def _get_all_followers(self, session: aiohttp.ClientSession, account_id: str) -> list[dict]:
        all_followers: list[dict] = []
        offset, limit = 0, 20

        while True:
            data = await self._get_followers_page(session, account_id, offset, limit)
            if not data or "list" not in data:
                break

            batch = data["list"] or []
            all_followers.extend(batch)
            if len(batch) < limit:
                break

            offset += limit
            await asyncio.sleep(0.5)  # –º—è–≥–∫–∏–π rate-limit

        return all_followers

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    @staticmethod
    def _extract_info(f: dict) -> dict:
        return {
            "account_id": str(f.get("account_id") or ""),
            "handle": f.get("handle") or "Unknown",
            "name": f.get("name") or f.get("handle") or "Unknown",
            "pic_url": f.get("pic_url") or "",
            "verified": bool(f.get("verified", False)),
            "is_vip": bool(f.get("is_vip", False)),
        }

    def _format_follow_message(self, info: dict, account_id: str) -> str:
        lines = [
            "üéµ –ù–æ–≤—ã–π –ø–æ–¥–ø–∏—Å—á–∏–∫!",
            "",
            f"üìä –ê–∫–∫–∞—É–Ω—Ç Smule: {account_id}",
            f"üë§ –ò–º—è: {info['name']}",
            f"üìù –ù–∏–∫: @{info['handle']}",
        ]
        if info["verified"]:
            lines.append("‚úÖ –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç")
        if info["is_vip"]:
            lines.append("‚≠ê VIP –∞–∫–∫–∞—É–Ω—Ç")
        if info["pic_url"]:
            lines.append(f"üñº –ê–≤–∞—Ç–∞—Ä: {info['pic_url']}")
        lines.append(f"üîó –ü—Ä–æ—Ñ–∏–ª—å: https://www.smule.com/{info['handle']}")
        lines.append(f"üïê –í—Ä–µ–º—è: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        return "\n".join(lines)

    def _format_unfollow_message(self, info: dict, account_id: str) -> str:
        lines = [
            "‚ùå –ü–æ–¥–ø–∏—Å—á–∏–∫ –æ—Ç–ø–∏—Å–∞–ª—Å—è!",
            "",
            f"üìä –ê–∫–∫–∞—É–Ω—Ç Smule: {account_id}",
            f"üë§ –ò–º—è: {info.get('name', 'Unknown')}",
            f"üìù –ù–∏–∫: @{info.get('handle', 'Unknown')}",
            f"üîó –ü—Ä–æ—Ñ–∏–ª—å: https://www.smule.com/{info.get('handle', 'Unknown')}",
            f"üïê –í—Ä–µ–º—è: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
        ]
        return "\n".join(lines)

    async def _send_text(self, text: str) -> None:
        try:
            await self.bot.send_message(chat_id=self.chat_id, text=text)
            logger.info("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram")
        except TelegramError as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram: {e}")

    async def _check_account(self, session: aiohttp.ClientSession, account_id: str) -> tuple[int, int]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (new_count, unfollow_count)
        """
        logger.info(f"–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –¥–ª—è –∞–∫–∫–∞—É–Ω—Ç–∞ {account_id}‚Ä¶")
        followers = await self._get_all_followers(session, account_id)
        if not followers:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –¥–ª—è –∞–∫–∫–∞—É–Ω—Ç–∞ {account_id}")
            return (0, 0)

        logger.info(f"–ü–æ–ª—É—á–µ–Ω–æ {len(followers)} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –¥–ª—è –∞–∫–∫–∞—É–Ω—Ç–∞ {account_id}")

        new_count = 0
        current_ids: set[str] = set()

        # –∫–∞—Ä—Ç–∞ id ‚Üí info –ø–æ —Ç–µ–∫—É—â–µ–π –≤—ã–±–æ—Ä–∫–µ
        current_map: dict[str, dict] = {}

        for f in followers:
            info = self._extract_info(f)
            fid = info["account_id"]
            if not fid:
                continue

            current_ids.add(fid)
            current_map[fid] = info

            # –ø–æ–ø–æ–ª–Ω–∏–º –¥–∏—Å–∫ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (–¥–ª—è –±—É–¥—É—â–∏—Ö –æ—Ç–ø–∏—Å–æ–∫)
            self.followers_meta.setdefault(account_id, {})
            self.followers_meta[account_id][fid] = info

            # –ù–æ–≤—ã–π –ø–æ–¥–ø–∏—Å—á–∏–∫
            if fid not in self.known_followers[account_id]:
                msg = self._format_follow_message(info, account_id)
                await self._send_text(msg)
                new_count += 1
                await asyncio.sleep(0.3)

        # –û—Ç–ø–∏—Å–∞–≤—à–∏–µ—Å—è (–±—ã–ª–∏ –≤ —Å–ª–µ–ø–∫–µ, –Ω–æ –∏—Ö –Ω–µ—Ç —Å–µ–π—á–∞—Å)
        unfollowed_ids = self.known_followers[account_id] - current_ids
        unfollow_count = len(unfollowed_ids)

        for fid in sorted(unfollowed_ids):
            # –¥–æ—Å—Ç–∞–Ω–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é –º–µ—Ç—É (–µ—Å–ª–∏ –µ—Å—Ç—å), —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å handle/name
            info = self.followers_meta.get(account_id, {}).get(fid, {
                "account_id": fid, "handle": fid, "name": fid
            })
            msg = self._format_unfollow_message(info, account_id)
            await self._send_text(msg)
            await asyncio.sleep(0.3)

            # –º–æ–∂–Ω–æ –ø–æ –∂–µ–ª–∞–Ω–∏—é —É–¥–∞–ª—è—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ—Ç–ø–∏—Å–∞–≤—à–∏—Ö—Å—è, –Ω–æ —è –æ—Å—Ç–∞–≤–ª—è—é
            # —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –Ω–∏–∫–æ–≤; –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —á–∏—Å—Ç–∏—Ç—å ‚Äî —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π:
            # self.followers_meta[account_id].pop(fid, None)

        # –û–±–Ω–æ–≤–∏–º —Å–ª–µ–ø–æ–∫ –∏ –º–µ—Ç—É –Ω–∞ –¥–∏—Å–∫
        self.known_followers[account_id] = current_ids
        self._save_followers_set(account_id)
        self._save_followers_meta(account_id)

        if new_count:
            logger.info(f"–ù–∞–π–¥–µ–Ω–æ {new_count} –Ω–æ–≤—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –¥–ª—è {account_id}")
        else:
            logger.info(f"–ù–æ–≤—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –Ω–µ—Ç –¥–ª—è {account_id}")
        if unfollow_count:
            logger.info(f"{unfollow_count} –ø–æ–¥–ø–∏—Å—á–∏–∫(–æ–≤) –æ—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç {account_id}")

        return (new_count, unfollow_count)

    async def check_new_followers(self) -> None:
        async with self._build_session() as session:
            total_new = 0
            total_left = 0

            for idx, account_id in enumerate(self.account_ids):
                try:
                    new_count, left_count = await self._check_account(session, account_id)
                    total_new += new_count
                    total_left += left_count
                    if idx < len(self.account_ids) - 1:
                        await asyncio.sleep(1.0)
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∞–∫–∫–∞—É–Ω—Ç–∞ {account_id}: {e}")
                    await self._send_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∞–∫–∫–∞—É–Ω—Ç–∞ {account_id}: {e}")

            # –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞ (–µ—Å–ª–∏ –±—ã–ª–æ —Ö–æ—Ç—å —á—Ç–æ-—Ç–æ)
            if total_new or total_left:
                parts = []
                if total_new:
                    parts.append(f"üîî –ù–æ–≤—ã—Ö: {total_new}")
                if total_left:
                    parts.append(f"‚ùå –û—Ç–ø–∏—Å–æ–∫: {total_left}")
                await self._send_text(f"üìä –°–≤–æ–¥–∫–∞: " + ", ".join(parts))

    async def run_continuous(self, check_interval: int = 300) -> None:
        logger.info(f"–ó–∞–ø—É—Å–∫–∞–µ–º –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è {len(self.account_ids)} –∞–∫–∫–∞—É–Ω—Ç–æ–≤ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º {check_interval} —Å–µ–∫—É–Ω–¥")
        logger.info(f"–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã: {', '.join(self.account_ids)}")

        while True:
            try:
                await self.check_new_followers()
                logger.info(f"–û–∂–∏–¥–∞–µ–º {check_interval} —Å–µ–∫—É–Ω–¥ –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏‚Ä¶")
                await asyncio.sleep(check_interval)
            except KeyboardInterrupt:
                logger.info("–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏")
                break
            except Exception as e:
                logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ —Ü–∏–∫–ª–∞: {e}")
                await asyncio.sleep(60)


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# main
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async def main():
    TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
    CHAT_ID = os.getenv("CHAT_ID")
    ACCOUNT_IDS_STR = os.getenv("SMULE_ACCOUNT_IDS")
    CHECK_INTERVAL = int(os.getenv("CHECK_INTERVAL", "300"))
    LOG_LEVEL = os.getenv("LOG_LEVEL", "INFO")

    logging.getLogger().setLevel(getattr(logging, LOG_LEVEL.upper(), logging.INFO))

    if ACCOUNT_IDS_STR:
        ACCOUNT_IDS = [x.strip() for x in ACCOUNT_IDS_STR.split(",") if x.strip()]
    else:
        ACCOUNT_IDS = []

    if not all([TELEGRAM_TOKEN, CHAT_ID, ACCOUNT_IDS]):
        logger.error("‚ùå –û–®–ò–ë–ö–ê: –ù–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!")
        logger.error("")
        logger.error("üìù –ü—Ä–∏–º–µ—Ä .env:")
        logger.error("=" * 50)
        logger.error("TELEGRAM_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞")
        logger.error("CHAT_ID=–≤–∞—à_chat_id")
        logger.error("SMULE_ACCOUNT_IDS=96242367,3150102762")
        logger.error("CHECK_INTERVAL=1800   # –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç")
        logger.error("LOG_LEVEL=INFO")
        logger.error("=" * 50)
        return

    logger.info(f"–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ë—É–¥—É—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å—Å—è {len(ACCOUNT_IDS)} –∞–∫–∫–∞—É–Ω—Ç–æ–≤: {', '.join(ACCOUNT_IDS)}")

    bot = SmuleFollowersBot(TELEGRAM_TOKEN, CHAT_ID, ACCOUNT_IDS)

    # –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ
    startup = [
        "ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!",
        f"üìä –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è {len(ACCOUNT_IDS)} –∞–∫–∫–∞—É–Ω—Ç–æ–≤:"
    ]
    startup += [f"{i+1}. {acc}" for i, acc in enumerate(ACCOUNT_IDS)]
    startup.append(f"‚è± –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏: {CHECK_INTERVAL} —Å–µ–∫—É–Ω–¥")
    await bot._send_text("\n".join(startup))

    await bot.run_continuous(CHECK_INTERVAL)


if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
